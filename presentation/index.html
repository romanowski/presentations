<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>Perspective change: huge Scala project from tooling perspective</title>
	<meta name="description" content="Perspective change: huge Scala project from tooling perspective">
	<meta name="author" content="Piotr Kukielka, Krzysztof Romanowski">

	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

	<meta name="viewport"
	      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

	<style type="text/css">
		.lefty {
		text-align: left;
		font-size: 65% !important;
		margin-left: 5%  !important;
		}
	</style>

	<link rel="stylesheet" href="css/reveal.css">
	<link rel="stylesheet" href="css/theme/black.css" id="theme">

	<!-- Code syntax highlighting -->
	<link rel="stylesheet" href="lib/css/zenburn.css">

	<!-- Printing and PDF exports -->
	<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
	</script>

	<!--[if lt IE 9]>
	<script src="lib/js/html5shiv.js"></script>
	<![endif]-->
</head>

<body>

<div class="reveal">

	<!-- Any section element inside of this container is displayed as a slide -->
	<div class="slides">

		<section data-markdown>
			<script type="text/template">
			### Piotr Kukielka

			piotr.kukielka@gmail.com

			<div style="margin-left: 36% text-align: left;">
				<img src="imgs/gh.png" style="background: none; border: none; margin: 0px"> pkukielka

				<img src="imgs/twitter.png" style="background: none; border: none; margin: 0px"> pkukielka

			</div>

			<br>

			### Krzysztof Romanowski

			romanowski.kr@gmail.com

			<div style="margin-left: 36% text-align: left;">
				<img src="imgs/gh.png" style="background: none; border: none; margin: 0px"> romanowski

				<img src="imgs/twitter.png" style="background: none; border: none; margin: 0px"> RomanowskiKr

			</div>

			<img src="imgs/vl.png" alt="Virtus Lab" style="background: none; border: none; box-shadow: none"/>

			</script>
		</section>

		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				## Perspective change:
				huge Scala project from tooling perspective

				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				## Plan

				1. Tooling provisioning. Challenge bigger then it seems - Piotr
				2. Incremental. Keyword for speed and problems - Krzysztof
				3. Stability starts with recovery
				4. Code quality - Piotr
				5. Tooling for support: in the search of repro- Krzysztof
				6. Bonus. The strangest caeses we ever saw.

				//kolejność do ustalenia - wpisałem losowo

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
					This is not a presentation about sbt, CI or IDE.

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				This is sum of expierience in providing tooling that integrate all this comoponensts.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Why do we need such tooling?
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				This is story how to provide scala workspaces for non-progrmers.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				This is story how about failing tooling.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Presentation can be found there:
				<br>

				//link do GH z gotową
				</script>
			</section>

		</section>

		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown><script type="text/template">
				##Tooling provisioning

				####Challenge bigger than it seems
			</script></section>

			<section data-markdown><script type="text/template">
				###What does the 'tooling' really mean?

				* Build automation systems, build scripts
				* IDEs with proper project structure and settings
				* Additional programs being part of the ecosystem
				* CI, test and prod environments
				* Distributed builds, caches...
			</script></section>

			<section data-markdown><script type="text/template">
				<div style="text-align: center;">
					One Tooling to rule them all,<br>
					One Tooling to find them,<br>
					One Tooling to bring them all<br>
					and in the darkness bind them
				</div>
				<br>
				<div style="text-align: center;">
					<img src="imgs/One_Ring_inscription.png" style="background: none; border: none">
				</div>
			</script></section>


			<section data-markdown><script type="text/template">
				###How does our infrastructure looks like?

				* Each repository contains different code and build scripts, but part of the build infrastructure is common
				* Tooling version is commited into version file (so it is subject to change during code pulls and branch changes)
			</script></section>

			<section data-markdown><script type="text/template">
				<div style="text-align: center;">
					<img src="imgs/tooling.png" style="background: none; border: none">
				</div>

			</script></section>

			<section data-markdown><script type="text/template">
				###What we have to provide?

				* Support for multiple repositories
				* Effortless upgrades and downgrades
				* Quick way to setup/reset whole environment

				Sounds easy?
			</script></section>

			<section data-markdown><script type="text/template">
				###Problems
			</script></section>

			<section data-markdown><script type="text/template">
				###No Ide is designed for that

				* Synchronization with build scripts is lacking
				* Re-generation of project structure takes minutes
				* Commandline options support is poor
			</script></section>

			<section data-markdown><script type="text/template">
				###We have to support multiple environments/workspaces
				* Dozens of environments at the same time
				* On different machines with different operating systems
				* Each can be upgraded or downgraded at any time by pull or branch change
				* Each can be fixed or restored - and depending on the failure severity it should be as quick as possible<br><br>

				####Existing solutions falls short.
			</script></section>


			<section data-markdown><script type="text/template">
				###Tooling need to reach outsie of user machine

				* Scala desperately need distributed compilation or external caching
				* Working implementation of distributed compilation in Scala does not exist
				* Caching requires a lot of resources, proper synchronization and custom extensions to your commandline and IDE build systems
			</script></section>

			<section data-markdown><script type="text/template">
				###Tooling should be able to fix itself

				With over 1M line of code and hundreds of developers:

				* IDEs will be breaking 'randomly'
				* Incremental compiler will be breaking 'randomly'
				* Everything else will... you get it :)<br><br>

				####At very least you need some way to:

				* Report the problem and make reproduction easier
				* **Fix user environment**
			</script></section>


			<section data-markdown><script type="text/template">
				###And should be smart about it

				Sure, you can always recreate whole workspace.

				But users does not like to wait.

				We try to fix only what is broken.

				The same applies for upgrades and downgrades.
			</script></section>
		</section>
		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				## Incremental
				#### Keyword for speed and potential problems
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Is always incremental compilation faster?
				</script>
			</section>


			<section data-markdown>
				<script type="text/template">
				Incremental can compilation be almost x3 slower.

				<img src="imgs/sbt-fix.png" style="background: none; border: none">

				https://github.com/romanowski/sbt/pull/1/files
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Why, oh why?

				Incremental compilation is done in cycles.

				Compile 5% later 20% later 60% and whole project in the end will take more time then full compile.

				Don't worry - this was result of mentioned problem.
				</script>
			</section>


			<section data-markdown>
				<script type="text/template">
				_from on support mailing list_
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				<div style="text-align: left;">
					_I compiled my project, all went fine. I tried to run my app and it fails with "No class def found"_
				</div>
				<br>
				<div style="text-align: right;">
					_Did you try to clean-build (rebuild) your project?_
				</div>
				<br>
				<div style="text-align: left;">
					_Full compilation failed (correctly). Why previous compilation was successful?_
				</div>
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## False Positives
				The biggest problem of incremental compilation

				<img src="imgs/false-positives.png" style="background: none; border: none">

				https://gist.github.com/romanowski/ae0da962a8b165e085db
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Bugs, bugs, bugs

				The bigger your workspace is the more bug you can face and they will hit more.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				### Speed

				We can't ask to spent ~30 minutes (this is actual number) on compilation for each change
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				### Incremental compilation is always balance between stability and speed.
				</script>
			</section>
		</section>
		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				## Stability starts with recovery
				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				There is no way that IDE will never broke.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Even if IDE breaks once a year in 365 workspaces it will break every day.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				_from on support mailing list_
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				<div style="text-align: left;">
					_I compiled my project, I got exception from compiler (...).
					Rebuilding and compiling project don't help.
					I don't change anything it that project (it is dependecy of my work)."_
				</div>
				<br>
				<div style="text-align: right;">
					_This is known problem. Please rebuild whole workspace and it should be gone._
				</div>
				<br>
				<div style="text-align: left;">
					_Thanks, it helped.
					However full build takes over 30 min, and I have to do it for no reason once a week.
					Can we do sth about this?_
				</div>
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Problem:

				Cleaning classes in Intellij's "Compile module xxx" is based on cache.

				Cache sometimes gets corrupted.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Such random corruptions (in cache, metadata) are really hard to identify.

				In most cases the only solution we can offer is some kind of recovery strategy.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Nuclear recovery
				(e.g. new workspace, Intellij's Rebuild project)

				Required minimum.

				The only problem is that nukes are expensive.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Can we do better?
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				### Targeted recovery?

				Quick and precise recovery strategy.
				</script>
			</section>


			<section data-markdown>
				<script type="text/template">
				Example
				_For mentioned  "Compile module xxx" cache corruption problem_

				Brute force clean that removes all classes (implemented by us).

				Fast, reliable recovery for single project compilation.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Why this is so important?

				If user can fix most of problem in few minuets with one click, this gives a feel of stability.

				If tooling works fine in 90% of time but in case of failure it needs hours to fix then it feels as unstable.

				(especially under deadline pression)
				</script>
			</section>

		</section>
		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown><script type="text/template">
				##Code quality

				####Good practices and help from the tooling
			</script></section>

			<section data-markdown><script type="text/template">
				##Tools will not save you

				If you want to write bad, hard to maintain code, you are doomed anyway.
			</script></section>

			<section data-markdown><script type="text/template">
				##But you can help yourself and the tools

				####All you need is:

				* Set of god practices
				* A bit of discipline
			</script></section>

			<section data-markdown><script type="text/template">
				##Good practices
			</script></section>

			<section data-markdown><script type="text/template">
				###If something should be private, make it private

				It's especially important in case commonly used objects, where you can avoid a lot of recompilation.

				Sbt name hashing partially mitigates this problem.
			</script></section>

			<section data-markdown><script type="text/template">
				###Explicitly specify type of public methods

				Compiler can infer type other than you think or make it more spcific than you need.

				You don't want that.
			</script></section>

			<section data-markdown><script type="text/template">
				###Compose traits to create bigger objects and classes

				```scala
				trait Programmer
				trait Administrator

				class DevOps extends Programmer with Administrator
				```
				```scala
				object Operations {
					def rebootMachine(admin: Administrator) = ???
				}
				```

				Changing `Programmer` have no effect on `Operations`.
				Just because `DevOps` class is not one big ball of mud.
			</script></section>

			<section data-markdown><script type="text/template">
				###Minimize the scope of implicits

				* Implicit resolution can significantly increase compilation time
				* Overuse of non-local implicits can be hard to understand
				* There is no tool which could do this job for you
			</script></section>

			<section data-markdown><script type="text/template">
				###Use typeclasses if they are right tool for the job

				* Your classes won't overgrow unnecessarily
				* You can limit scope of recompilation when working on typeclasses instead of the target class body
			</script></section>

			<section data-markdown><script type="text/template">
				##So what tools can do for you?
			</script></section>

			<section data-markdown><script type="text/template">
				###Code Formatting

				* Scalariform and other external formatters
				* IntelliJ and ScalaIDE formatters - incompatible :(
			</script></section>

			<section data-markdown><script type="text/template">
				###Linters and static analysers

				* IntelliJ Inspections
				* Wart remover https://github.com/typelevel/wartremover
				* Linter https://github.com/HairyFotr/linter
				* CPD https://github.com/sbt/cpd4sbt
				* Abide https://github.com/scala/scala-abide
				* Scapegoat https://github.com/sksamuel/scalac-scapegoat-plugin

				Most of that tools is still work in  progress though.
			</script></section>

			<section data-markdown><script type="text/template">
				###And there is still a lot to be done...

				####To name few possible problems:

				* Automatic type insertion (for public methods) - no tool can reliably do it for whole codebase
				* Implicits scope analyse, reporting, and auto-fixing

				Building that kind of tools should become easier with scala.meta -  when it will be there.
			</script></section>

		</section>
		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				## Tooling for support:

				#### in the search of repro
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Usual thread on support mailing list
				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				<div style="text-align: left;">
				_I changed leaf project then compiled, but when I tried to run my application it compiled whole workspace._
				</div>
				<br>
				<div style="text-align: right;">
				_Can you give me more details?<br> Version of platform-X, branch/repository, installation detalis_
				</div>
				<br>
				<div style="text-align: left;">
				_Where I can find version of platform-X?_
				</div>

				... After multiple messages sent...

				<div style="text-align: right;">
					_Sorry I cannot reproduce your problem._
				</div>
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Similar problem was reported multiple times.

				After hours spent of searching for repeatable repro problem was finally found and reported.

				```scala
				//Inside project A
				trait X

				class A
				//commenting this line affacting ClassAsGenericBoundUsage on X
				extends X

				//Inside project B that depends on A

				//This class will be compiled when line 5 is commented
				class B {
				//this has ClassAsGenericBoundUsage on X
					def foo: Option[X] = None
				}
				```
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Usually without reproduction cause cannot be found,<br/>so problem cannot be properly fixed/reported.

				### How to find reproduction?

				Tools always work at creator's machine...
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Problem with repros: even really small detail can matter

				<img src="imgs/evenSmallDetali.png" style="background: none; border: none">


				https://youtrack.jetbrains.com/issue/SCL-9532
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Wishful thinking...

				<img src="imgs/steps-sbt.png" style="background: none; border: none">
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Manual approach

				In the end tooling developer needs to find repro himself/herslelf.

				The only think that can be approved is how many work needs to be put here.
				</script>
			</section>


			<section data-markdown>
				<script type="text/template">
				## Error reports

				1. Easy for end user: one click + short description
				2. Powerful for developer: contains as much information as possible
				3. Legal issues: cannot expose non-public code
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Statistics gathering

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Self-diagnostic tools

				1. Deadlock detetction (from Intellij)
				2. Tweaks in ScalaIDE (named compilation threads)
				3. API Changes from SBT's name hashing

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Beware!
				It can break your tooling

				1. Problems with namehashing api changes
				2. Deadlock detection that breaks long compilations
				3. Time losses on tracking

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				#### All tools developers, we kindy ask for:

				1. Possibilty to log as much as possible.
					<br>What was compiled, what trigger change etc.
					<br>We want to know what happens inside problematic ws!
				2. Allow us to easily connect with debugger. Intellij's compiler.debug.port FTW!
				3. Tag your releases. Documentation is never enough. We want see actual code
				4. Don't depend on snapshots in releases. Later you are always missing them

				</script>
			</section>

		</section>
		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				Radnom points.
				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				If you got task that produce no output and after minute it prints "OK" it is consider as long.

				If the same task prints information every 5 secs it is consider as not that long.
				</script>
			</section>

		</section>
		<!-- ################################################################################################################ -->


		<section>
			<section data-markdown>
				<script type="text/template">
				Podsumowanie 1
				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				Podsumowanie 2
				</script>

			</section>

		</section>
		<!-- ################################################################################################################ -->

		<section>

			<section data-markdown>
				<script type="text/template">
				<!--to jest kopia 1 slajdu-->
				### Piotr Kukielka

				piotr.kukielka@gmail.com

				<div style="margin-left: 36% text-align: left;">
					<img src="imgs/gh.png" style="background: none; border: none; margin: 0px"> pkukielka

					<img src="imgs/twitter.png" style="background: none; border: none; margin: 0px"> pkukielka

				</div>

				<br>

				### Krzysztof Romanowski

				romanowski.kr@gmail.com

				<div style="margin-left: 36% text-align: left;">
					<img src="imgs/gh.png" style="background: none; border: none; margin: 0px"> romanowski

					<img src="imgs/twitter.png" style="background: none; border: none; margin: 0px"> RomanowskiKr

				</div>

				<img src="imgs/vl.png" alt="Virtus Lab" style="background: none; border: none; box-shadow: none"/>

				</script>
			</section>
		</section>

		<!-- ################################################################################################################ -->
	</div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});


</script>

</body>
</html>
