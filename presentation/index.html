<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>Perspective change: huge Scala project from tooling perspective</title>
	<meta name="description" content="Perspective change: huge Scala project from tooling perspective">
	<meta name="author" content="Piotr Kukielka, Krzysztof Romanowski">

	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

	<meta name="viewport"
	      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

	<style type="text/css">
		.lefty {
		text-align: left;
		font-size: 65% !important;
		margin-left: 5%  !important;
		}
	</style>

	<link rel="stylesheet" href="css/reveal.css">
	<link rel="stylesheet" href="css/theme/black.css" id="theme">

	<!-- Code syntax highlighting -->
	<link rel="stylesheet" href="lib/css/zenburn.css">

	<!-- Printing and PDF exports -->
	<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
	</script>

	<!--[if lt IE 9]>
	<script src="lib/js/html5shiv.js"></script>
	<![endif]-->
</head>

<body>

<div class="reveal">

	<!-- Any section element inside of this container is displayed as a slide -->
	<div class="slides">

		<section data-markdown>
			<script type="text/template">
			### Piotr Kukielka

			piotr.kukielka@gmail.com

			<div style="margin-left: 36% text-align: left;">
				<img src="imgs/gh.png" style="background: none; border: none; margin: 0px"> pkukielka

				<img src="imgs/twitter.png" style="background: none; border: none; margin: 0px"> pkukielka

			</div>

			<br>

			### Krzysztof Romanowski

			romanowski.kr@gmail.com

			<div style="margin-left: 36% text-align: left;">
				<img src="imgs/gh.png" style="background: none; border: none; margin: 0px"> romanowski

				<img src="imgs/twitter.png" style="background: none; border: none; margin: 0px"> RomanowskiKr

			</div>

			<img src="imgs/vl.png" alt="Virtus Lab" style="background: none; border: none; box-shadow: none"/>

			</script>
		</section>

		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				## Perspective change:
				####Huge Scala project from tooling perspective

				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				## Plan

				1. Tooling at scale. Challenge bigger then it seems
				2. Incremental. Keyword for speed and problems
				3. Stability starts with recovery
				4. Tooling for support: in the search of repro
				5. Bonus. The strangest caeses we ever saw
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
					This is not a presentation about sbt, CI or IDE.

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				This is sum of expierience in providing tooling that integrate all this comoponensts.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Why do we need such tooling?
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				This is story how to provide scala workspaces for non-progrmers.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				This is story about failing tooling.
				</script>
			</section>

			<!--
			<section data-markdown>
				<script type="text/template">
				Presentation can be found there:
				<br>
				</script>
			</section>
			-->
		</section>

		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown><script type="text/template">
				##Tooling at scale

				####Challenge bigger than it seems
			</script></section>

			<section data-markdown><script type="text/template">
				###What does the 'tooling' really mean?

				* Build automation systems, build scripts
				* IDEs with proper project structure and settings
				* Additional programs being part of the ecosystem
				* CI, test and prod environments
				* Distributed builds, caches...
			</script></section>

			<section data-markdown><script type="text/template">
				<div style="text-align: center;">
					One Tooling to rule them all,<br>
					One Tooling to find them,<br>
					One Tooling to bring them all<br>
					and in the darkness bind them
				</div>
				<br>
				<div style="text-align: center;">
					<img src="imgs/One_Ring_inscription.png" style="background: none; border: none">
				</div>
			</script></section>

			<section data-markdown><script type="text/template">
				###What we have to provide?

				* Support for multiple repositories
				* Effortless upgrades and downgrades
				* Quick way to setup/reset whole environment
				* Good IDE integration and synchronization

				Sounds easy, right?
			</script></section>

			<section data-markdown><script type="text/template">
				###Problems & solutions
			</script></section>

			<section data-markdown data-background="#b5533c"><script type="text/template">
				###Problem: We have to support multiple environments/workspaces

				* Dozens of environments at the same time
				* On different machines with different operating systems
				* Each can be upgraded or downgraded at any time by pull or branch change
				* Each can be fixed or restored - and depending on the failure severity it should be as quick as possible<br><br>

				####Existing solutions falls short.
			</script></section>

			<section data-markdown data-background="#2F5938"><script type="text/template">
				###Solution: Version change management
			</script></section>

			<section data-markdown><script type="text/template">
				###How does our infrastructure looks like?

				* Each repository contains different code and build scripts, but part of the build infrastructure is common
				* Tooling version is commited into version file (so it is subject to change during code pulls and branch changes)

				<div style="text-align: center;">
					<img src="imgs/tooling.png" style="background: none; border: none">
				</div>
			</script></section>

			<section data-markdown><script type="text/template">
				###When version changes...

				Tooling need to be able to discover changes in:

				* IDE version
				* Project structure
				* Config scripts
				* And more...

				And update accordingly.

				Differet granuality of 'clean and restore' actions is required.
			</script></section>

			<section data-markdown data-background="#b5533c"><script type="text/template">
				###Problem: No Ide can handle it automatically

				* Synchronization with build scripts is lacking
				* Re-generation of project structure takes minutes
				* Commandline options support is poor
				* Some options, like building custom compler plugin as part of the build, are missing
			</script></section>

			<section data-markdown data-background="#2F5938"><script type="text/template">
				###Solution (ideal world): <br>Improve integration with build scripts
				<br>
				###Solution (real world): <br>Hack over each problem
			</script></section>

			<section data-markdown><script type="text/template">
				###Project files regeneration

				You need to choose if you prefer accuracy or speed.

				Not every change in build files causes change in project structure.

				We let users to decide.
			</script></section>

			<section data-markdown><script type="text/template">
				###Custom requirements

				Better learn how to write IDE plugins.

				You will have to hack:

				* Presentation compiler support <br> (google for: *IntelliJ API to Build Scala Macros Support*)
				* Builders <br> (google for: *External Builder API and Plugins*)
				* Everytihing else <br> (just go straight to the sources :))
			</script></section>

			<section data-markdown data-background="#b5533c"><script type="text/template">
				###Problem: Tooling need to make up for Scala shortcomings
				* Scala desperately need distributed compilation or external caching
				* Working implementation of distributed compilation in Scala does not exist
				* Caching requires a lot of resources, proper synchronization and custom extensions to your commandline and IDE build systems
			</script></section>


			<section data-markdown data-background="#2F5938"><script type="text/template">
				###Solution: Smart caching
			</script></section>

			<section data-markdown><script type="text/template">
				###Get help form the CI

				If some project have no sources changed, why not use jars generated by CI?
			</script></section>

			<section data-markdown><script type="text/template">
				####Subproblems:

				* How to discover if there are "no sources changed"
				* How to invalidate caches/jars on CI (it will grow FAST)

				<br>

				####Downsides:

				* You need separate implementation for both commandline and IDE build
				* Change in one file causes re-compilation of the whole project
			</script></section>

			<section data-markdown><script type="text/template">
				###Get help form the CI - second approach

				Use sbt build with name hashing enabled.<br>
				Let the incremental compilation do the job.
			</script></section>

			<section data-markdown><script type="text/template">
				####Benefits:

				* You don't need exact cache hit anymore
				* Change in one file causes smallest possible recompilation
				* You need less space on CI side
				* If your IDE support sbt build you can have almost the same implementation for both commandline and IDE build

				<br>

				####Downsides:

				* Bugs in sbt incremental compilation can kill you
			</script></section>

			<section data-markdown data-background="#b5533c"><script type="text/template">
				###Problem: Tooling should be resistant to random failures

				With over 1M line of code and hundreds of developers:

				* IDEs will be breaking 'randomly'
				* Incremental compiler will be breaking 'randomly'
				* Everything else will... you get it :)<br><br>
			</script></section>

			<section data-markdown data-background="#2F5938"><script type="text/template">
				###Solution: Report and recover
			</script></section>

			<section data-markdown><script type="text/template">
				You need to accept sad reality:<br>
				**something will eventually fail**

				In many cases failures are caused by tools outside of your control.

				What you can do is report th problem and recover from error. Mostly by partial or full re-creation of the workspace.
			</script></section>

			<section data-markdown data-background="#b5533c"><script type="text/template">
				###Problem: Often tools are not enough (or are not good enough)
			</script></section>

			<section data-markdown data-background="#2F5938"><script type="text/template">
				###Solution 1: Good practices and discipline

				###Solution 2: Let's make better tools :)
			</script></section>

			<section data-markdown><script type="text/template">
				###To name just a few rules:

				* If something should be private, make it private
				* Explicitly specify type of public methods
				* Minimize the scope of implicits
				* Compose traits to create bigger objects and classes
			</script></section>

			<section data-markdown><script type="text/template">
				###Most of that things should be done automaticallly

				* Automatic type insertion (for public methods) - no tool can reliably do it for whole codebase
				* Implicits scope analyse, reporting, and auto-fixing

				Hopefully building that kind of tools will become easier with Scala.Meta.
			</script></section>

		</section>

		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				## Incremental
				#### Keyword for speed and potential problems
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Is incremental compilation always faster?
				</script>
			</section>


			<section data-markdown>
				<script type="text/template">
				Incremental compilation can be almost x3 slower.

				<img src="imgs/sbt-fix.png" style="background: none; border: none">

				https://github.com/romanowski/sbt/pull/1/files
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Why, oh why?

				Incremental compilation is done in cycles.

				Compile 5%, later 20%, later 60%, and whole project in the end will take more time than full compile.

				Don't worry - this was result of mentioned problem.
				</script>
			</section>


			<section data-markdown>
				<script type="text/template">
				_from support mailing list_
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				<div style="text-align: left;">
					_I compiled my project, all went fine. I tried to run my app and it fails with "No class def found"_
				</div>
				<br>
				<div style="text-align: right;">
					_Did you try to clean-build (rebuild) your project?_
				</div>
				<br>
				<div style="text-align: left;">
					_Full compilation failed (correctly). Why previous compilation was successful?_
				</div>
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## False Positives
				The biggest problem of incremental compilation

				<img src="imgs/false-positives.png" style="background: none; border: none">

				https://gist.github.com/romanowski/ae0da962a8b165e085db
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Bugs, bugs, bugs

				The bigger your workspace is the more bugs you can face and they will hit more.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				### Speed

				We can't ask to spend ~30 minutes (this is actual number) on compilation for each change
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				### Incremental compilation is always balance between stability and speed.
				</script>
			</section>
		</section>
		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				## Stability starts with recovery
				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				There is no way that IDE will never broke.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Even if IDE breaks once a year in 365 workspaces it will break every day.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				_from on support mailing list_
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				<div style="text-align: left;">
					_I compiled my project, I got exception from compiler (...).
					Rebuilding and compiling project don't help.
					I don't change anything it that project (it is dependecy of my work)."_
				</div>
				<br>
				<div style="text-align: right;">
					_This is known problem. Please rebuild whole workspace and it should be gone._
				</div>
				<br>
				<div style="text-align: left;">
					_Thanks, it helped.
					However full build takes over 30 min, and I have to do it for no reason once a week.
					Can we do sth about this?_
				</div>
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Problem:

				Cleaning classes in Intellij's "Compile module xxx" is based on cache.

				Cache sometimes gets corrupted.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Such random corruptions (in cache, metadata) are really hard to identify.

				In most cases the only solution we can offer is some kind of recovery strategy.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Nuclear recovery
				(e.g. new workspace, Intellij's Rebuild project)

				Required minimum.

				The only problem is that nukes are expensive.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Can we do better?
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				### Targeted recovery?

				Quick and precise recovery strategy.
				</script>
			</section>


			<section data-markdown>
				<script type="text/template">
				Example
				_For mentioned  "Compile module xxx" cache corruption problem_

				Brute force clean that removes all classes (implemented by us).

				Fast, reliable recovery for single project compilation.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Why this is so important?

				If user can fix most of problem in few minuets with one click, this gives a feel of stability.

				If tooling works fine in 90% of time but in case of failure it needs hours to fix then it feels as unstable.

				(especially under deadline pression)`
				</script>
			</section>

		</section>
		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				## Tooling for support:

				#### in the search of repro
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Usual thread on support mailing list
				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				<div style="text-align: left;">
				_I changed leaf project then compiled, but when I tried to run my application it compiled whole workspace._
				</div>
				<br>
				<div style="text-align: right;">
				_Can you give me more details?<br> Version of platform-X, branch/repository, installation detalis_
				</div>
				<br>
				<div style="text-align: left;">
				_Where I can find version of platform-X?_
				</div>

				... After multiple messages sent...

				<div style="text-align: right;">
					_Sorry I cannot reproduce your problem._
				</div>
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Similar problem was reported multiple times.

				After hours spent of searching for repeatable repro problem was finally found and reported.

				```scala
				//Inside project A
				trait X

				class A
				//commenting this line affacting ClassAsGenericBoundUsage on X
				extends X

				//Inside project B that depends on A

				//This class will be compiled when line 5 is commented
				class B {
				//this has ClassAsGenericBoundUsage on X
					def foo: Option[X] = None
				}
				```
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Usually without reproduction cause cannot be found,<br/>so problem cannot be properly fixed/reported.

				### How to find reproduction?

				Tools always work at creator's machine...
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				Problem with repros: even really small detail can matter

				<img src="imgs/evenSmallDetali.png" style="background: none; border: none">


				https://youtrack.jetbrains.com/issue/SCL-9532
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Wishful thinking...

				<img src="imgs/steps-sbt.png" style="background: none; border: none">
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Manual approach

				In the end tooling developer needs to find repro himself/herslelf.

				The only think that can be approved is how many work needs to be put here.
				</script>
			</section>


			<section data-markdown>
				<script type="text/template">
				## Error reports

				1. Easy for end user: one click + short description
				2. Powerful for developer: contains as much information as possible
				3. Legal issues: cannot expose non-public code
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Statistics gathering

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Self-diagnostic tools

				1. Deadlock detetction (from Intellij)
				2. Tweaks in ScalaIDE (named compilation threads)
				3. API Changes from SBT's name hashing

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Beware!
				It can break your tooling

				1. Problems with namehashing api changes
				2. Deadlock detection that breaks long compilations
				3. Time losses on tracking

				</script>
			</section>

		</section>
		<!-- ################################################################################################################ -->

		<section>
			<section data-markdown>
				<script type="text/template">
				Radnom points.
				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				#### All tools developers, we kindy ask for:

				1. Possibilty to log as much as possible.
				<br>What was compiled, what trigger change etc.
				<br>We want to know what happens inside problematic ws!
				2. Allow us to easily connect with debugger. Intellij's compiler.debug.port FTW!
				3. Tag your releases. Documentation is never enough. We want see actual code
				4. Don't depend on snapshots in releases. Later you are always missing them

				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				If you got task that produce no output and after minute it prints "OK" it is consider as long.

				If the same task prints information every 5 secs it is consider as not that long.
				</script>
			</section>

			<section data-markdown>
				<script type="text/template">
				## Statistics gathering
				</script>
			</section>

		</section>
		<!-- ################################################################################################################ -->


		<section>
			<section data-markdown>
				<script type="text/template">
				Podsumowanie 1
				</script>

			</section>

			<section data-markdown>
				<script type="text/template">
				Podsumowanie 2
				</script>

			</section>

		</section>
		<!-- ################################################################################################################ -->

		<section>

			<section data-markdown>
				<script type="text/template">
				<!--to jest kopia 1 slajdu-->
				### Piotr Kukielka

				piotr.kukielka@gmail.com

				<div style="margin-left: 36% text-align: left;">
					<img src="imgs/gh.png" style="background: none; border: none; margin: 0px"> pkukielka

					<img src="imgs/twitter.png" style="background: none; border: none; margin: 0px"> pkukielka

				</div>

				<br>

				### Krzysztof Romanowski

				romanowski.kr@gmail.com

				<div style="margin-left: 36% text-align: left;">
					<img src="imgs/gh.png" style="background: none; border: none; margin: 0px"> romanowski

					<img src="imgs/twitter.png" style="background: none; border: none; margin: 0px"> RomanowskiKr

				</div>

				<img src="imgs/vl.png" alt="Virtus Lab" style="background: none; border: none; box-shadow: none"/>

				</script>
			</section>
		</section>

		<!-- ################################################################################################################ -->
	</div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});


</script>

</body>
</html>
